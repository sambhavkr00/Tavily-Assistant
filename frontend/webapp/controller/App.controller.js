sap.ui.define(
  ["sap/ui/core/mvc/Controller", "sap/ui/model/json/JSONModel"],
  function (Controller, JSONModel) {
    "use strict";

    return Controller.extend("tavily.assistant.frontend.controller.App", {
      onInit: function () {
        // Set a default model for the view
        var sInitialResponse =
          "Responses will be generated by a Large Language Model (LLM) and may not always be accurate.";
        var sHtmlInitialResponse = marked.parse(sInitialResponse);
        var oModel = new JSONModel({
          prompt: "",
          response: sHtmlInitialResponse,
        });
        this.getView().setModel(oModel);
        // Generate a unique session ID for the user
        this.sSessionId = this._generateUUID();
      },

      _generateUUID: function () {
        // A simple UUID generator
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            var r = (Math.random() * 16) | 0,
              v = c === "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          }
        );
      },

      onSendPress: function () {
        var oView = this.getView();
        var oModel = oView.getModel();
        var sPrompt = oView.byId("promptInput").getValue();

        if (!sPrompt) {
          return;
        }

        oModel.setProperty("/response", "");
        oView.setBusy(true);

        // Replace with your backend URL
        var sBackendUrl = "/api";

        fetch(sBackendUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            prompt: sPrompt,
            session_id: this.sSessionId,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            var sResponse = data.output || data.error;
            var sHtmlResponse = marked.parse(sResponse);
            oModel.setProperty("/response", sHtmlResponse);
          })
          .catch((error) => {
            var sErrorResponse = marked.parse("Error: " + error.message);
            oModel.setProperty("/response", sErrorResponse);
          })
          .finally(function () {
            oView.setBusy(false);
          });
      },
    });
  }
);
